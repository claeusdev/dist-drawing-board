global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# Stats frontend with Prometheus endpoint
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    # Enable Prometheus metrics endpoint
    http-request use-service prometheus-exporter if { path /metrics }

frontend websocket_frontend
    bind *:8000
    mode http
    
    # WebSocket configuration
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_websocket hdr_beg(Host) -i ws

    use_backend websocket_backend if is_websocket
    default_backend websocket_backend


backend websocket_backend
    mode http
    balance roundrobin
    option forwardfor
    
    # WebSocket specific options
    option http-server-close
    option http-pretend-keepalive
    
    server ws1 websocket1:8081 check cookie ws1
    server ws2 websocket2:8082 check cookie ws2
    server ws3 websocket3:8083 check cookie ws3

    timeout tunnel 3600s
    timeout server 30s
